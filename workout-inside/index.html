<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Workout Inside - Reminder</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .progress-bar-timer {
      transition: width 1s linear;
    }
    .reminder-card {
      transition: transform 0.2s;
      cursor: pointer; /* Add cursor pointer for clickable shared reminders */
    }
    .reminder-card:hover {
      transform: translateY(-2px);
    }
    /* Stile per nascondere l'ID utente grezzo, se si preferisce mostrare solo il nickname */
    .user-id-raw {
        display: none;
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">Workout Inside</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto" id="main-nav">
          <li class="nav-item"><a class="nav-link active" href="#" data-bs-target="my-reminders">Miei Reminder</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-bs-target="shared-reminders">Reminder Condivisi</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-bs-target="questions">Domande</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#nicknameModal">Profilo</a></li>
        </ul>
        <span id="user-nickname-display" class="navbar-text me-3" style="display: none;"></span>
        <button id="btn-logout" class="btn btn-outline-light">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <div id="auth-container" class="row justify-content-center">
      <div class="col-md-6">
        <div class="card shadow">
          <div class="card-body">
            <h2 class="card-title text-center mb-4">Accedi/Registrati</h2>
            <input type="email" id="email" class="form-control mb-3" placeholder="Email">
            <input type="password" id="password" class="form-control mb-3" placeholder="Password">
            <div class="d-grid gap-2">
              <button id="btn-login" class="btn btn-primary">Accedi</button>
              <button id="btn-signup" class="btn btn-success">Registrati</button>
              <button id="btn-google" class="btn btn-danger">Continua con Google</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="app-container" style="display: none;">
      <div id="my-reminders" class="content-section">
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#newReminderModal" id="btn-open-new-reminder-modal">
          + Nuovo Reminder
        </button>
        <div id="reminders-list" class="row g-4"></div>
      </div>

      <div id="shared-reminders" class="content-section" style="display: none;">
        <div class="row mb-3">
          <div class="col-md-6">
            <input type="text" id="search-shared-reminders" class="form-control" placeholder="Cerca reminder condivisi...">
          </div>
          <div class="col-md-3">
            <select id="sort-shared-reminders" class="form-select">
              <option>Ordina per punteggio</option>
              <option>Ordina casualmente</option>
              <option>Ordina per data (nuovi prima)</option>
            </select>
          </div>
        </div>
        <div id="shared-reminders-list" class="row g-4"></div>
      </div>

      <div id="questions" class="content-section" style="display: none;">
        <p>Sezione Domande (da implementare)</p>
      </div>
    </div>
  </div>

  <div class="modal fade" id="newReminderModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reminderModalTitle">Nuovo Reminder</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="reminder-id"> <div class="mb-3">
            <label for="reminder-title" class="form-label">Titolo*</label>
            <input type="text" id="reminder-title" class="form-control" placeholder="Titolo del reminder" required>
          </div>
          <div class="mb-3">
            <label for="reminder-description" class="form-label">Descrizione</label>
            <textarea id="reminder-description" class="form-control" placeholder="Descrizione (opzionale)"></textarea>
          </div>
          <div class="mb-3">
             <label for="reminder-time" class="form-label">Ora</label>
            <input type="time" id="reminder-time" class="form-control">
          </div>
          <div class="mb-3">
            <label for="reminder-days" class="form-label">Giorni (seleziona per ricorrenza)</label>
            <select id="reminder-days" class="form-select" multiple>
              <option value="1">Lunedì</option>
              <option value="2">Martedì</option>
              <option value="3">Mercoledì</option>
              <option value="4">Giovedì</option>
              <option value="5">Venerdì</option>
              <option value="6">Sabato</option>
              <option value="0">Domenica</option>
            </select>
          </div>
          <div class="form-check mb-2">
            <input type="checkbox" id="timer-enabled" class="form-check-input">
            <label class="form-check-label" for="timer-enabled">Abilita Timer</label>
          </div>
          <input type="number" id="timer-duration" class="form-control mb-2" placeholder="Durata timer (minuti)" disabled>
          <div class="form-check mb-2">
            <input type="checkbox" id="share-checkbox" class="form-check-input">
            <label class="form-check-label" for="share-checkbox">Condividi pubblicamente questo reminder</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button id="btn-save-reminder" class="btn btn-primary">Salva Reminder</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="nicknameModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Imposta/Modifica Nickname</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Il tuo nickname sarà visibile quando condividi i reminder.</p>
          <input type="text" id="nickname-input" class="form-control" placeholder="Il tuo nickname">
          <small id="nickname-error" class="text-danger"></small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button id="btn-save-nickname" class="btn btn-primary">Salva Nickname</button>
        </div>
      </div>
    </div>
  </div>

  <template id="timer-template">
    <div class="timer-container mt-2">
      <div class="progress mb-2" style="height: 20px;">
        <div class="progress-bar progress-bar-timer bg-info" role="progressbar" style="width: 100%"></div>
      </div>
      <button class="btn btn-sm btn-start-timer btn-success">Avvia Timer</button>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, where, updateDoc, getDoc, setDoc, serverTimestamp, orderBy, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      // INCOLLA QUI LA TUA CONFIGURAZIONE FIREBASE
      apiKey: "xxxxxxxxxxxxxxx", // SOSTITUISCI CON LA TUA API KEY
      authDomain: "xxxxxxxxxxxxxxx", // SOSTITUISCI
      projectId: "xxxxxxxxxxxxxxx", // SOSTITUISCI
      storageBucket: "xxxxxxxxxxxxxxx", // SOSTITUISCI
      messagingSenderId: "xxxxxxxxxxxxxxx", // SOSTITUISCI
      appId: "xxxxxxxxxxxxxxx" // SOSTITUISCI
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let userNickname = '';
    let editingReminderId = null; // Per tracciare se stiamo modificando un reminder esistente
    const newReminderModal = new bootstrap.Modal(document.getElementById('newReminderModal'));
    const nicknameModal = new bootstrap.Modal(document.getElementById('nicknameModal'));

    // Utils
    function clearReminderModal() {
        document.getElementById('reminder-id').value = '';
        document.getElementById('reminder-title').value = '';
        document.getElementById('reminder-description').value = '';
        document.getElementById('reminder-time').value = '';
        document.getElementById('reminder-days').querySelectorAll('option').forEach(opt => opt.selected = false);
        document.getElementById('timer-enabled').checked = false;
        document.getElementById('timer-duration').value = '';
        document.getElementById('timer-duration').disabled = true;
        document.getElementById('share-checkbox').checked = false;
        document.getElementById('reminderModalTitle').textContent = 'Nuovo Reminder';
        editingReminderId = null;
    }

    document.getElementById('btn-open-new-reminder-modal').addEventListener('click', () => {
        clearReminderModal();
    });


    // Gestione Nickname
    async function fetchUserNickname(userId) {
        if (!userId) return 'Utente Anonimo';
        const userDocRef = doc(db, 'users', userId);
        const userDocSnap = await getDoc(userDocRef);
        if (userDocSnap.exists() && userDocSnap.data().nickname) {
            return userDocSnap.data().nickname;
        }
        return 'Utente Anonimo'; // o userId se si preferisce
    }

    async function checkAndPromptForNickname(user) {
        const userDocRef = doc(db, 'users', user.uid);
        const userDocSnap = await getDoc(userDocRef);
        if (!userDocSnap.exists() || !userDocSnap.data().nickname) {
            console.log("Nickname non trovato, apro il modal.");
            nicknameModal.show();
        } else {
            userNickname = userDocSnap.data().nickname;
            document.getElementById('user-nickname-display').textContent = `Ciao, ${userNickname}!`;
            document.getElementById('user-nickname-display').style.display = 'inline';
            document.getElementById('nickname-input').value = userNickname; // Precompila nel modal
        }
    }

    document.getElementById('btn-save-nickname')?.addEventListener('click', async () => {
        const newNickname = document.getElementById('nickname-input').value.trim();
        const nicknameError = document.getElementById('nickname-error');
        nicknameError.textContent = '';

        if (!newNickname || newNickname.length < 3) {
            nicknameError.textContent = 'Il nickname deve avere almeno 3 caratteri.';
            return;
        }
        if (!currentUser) {
            alert("Utente non autenticato.");
            return;
        }
        try {
            await setDoc(doc(db, 'users', currentUser.uid), { nickname: newNickname }, { merge: true });
            userNickname = newNickname;
            document.getElementById('user-nickname-display').textContent = `Ciao, ${userNickname}!`;
            document.getElementById('user-nickname-display').style.display = 'inline';
            nicknameModal.hide();
            alert("Nickname salvato con successo!");
        } catch (err) {
            console.error("Errore salvataggio nickname:", err);
            alert("Errore durante il salvataggio del nickname: " + err.message);
        }
    });


    window.addEventListener('DOMContentLoaded', () => {
      // Google login
      document.getElementById('btn-google')?.addEventListener('click', async () => {
        const provider = new GoogleAuthProvider();
        try {
          const result = await signInWithPopup(auth, provider);
          console.log("Google login success:", result.user.email);
          // checkAndPromptForNickname(result.user); // Spostato in onAuthStateChanged
        } catch (err) {
          console.error("Google login error:", err.message);
          alert("Errore login Google: " + err.message);
        }
      });

      // Email login
      document.getElementById('btn-login')?.addEventListener('click', async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) {
            alert("Inserisci email e password.");
            return;
        }
        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (err) {
          alert("Errore login: " + err.message);
        }
      });

      // Signup
      document.getElementById('btn-signup')?.addEventListener('click', async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
         if (!email || !password) {
            alert("Inserisci email e password per registrarti.");
            return;
        }
        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          // Dopo la registrazione, chiedi subito il nickname
          // checkAndPromptForNickname(userCredential.user); // Spostato in onAuthStateChanged
        } catch (err) {
          alert("Errore registrazione: " + err.message);
        }
      });

      // Logout
      document.getElementById('btn-logout')?.addEventListener('click', () => {
        signOut(auth).then(() => {
            currentUser = null;
            userNickname = '';
            document.getElementById('user-nickname-display').style.display = 'none';
        }).catch(err => alert("Errore logout: " + err.message));
      });

      // Save (Add or Update) reminder
      document.getElementById('btn-save-reminder')?.addEventListener('click', async () => {
        if (!currentUser) {
            alert("Devi essere loggato per aggiungere un reminder.");
            return;
        }

        const title = document.getElementById('reminder-title').value.trim();
        if (!title) {
            alert("Il titolo del reminder è obbligatorio.");
            return;
        }

        const reminderData = {
          title: title,
          description: document.getElementById('reminder-description').value.trim(),
          time: document.getElementById('reminder-time').value,
          days: Array.from(document.getElementById('reminder-days').selectedOptions).map(o => o.value),
          timerEnabled: document.getElementById('timer-enabled').checked,
          timerDuration: document.getElementById('timer-duration').value ? parseInt(document.getElementById('timer-duration').value) : 0,
          userId: currentUser.uid,
          userNickname: userNickname || 'Utente Anonimo', // Salva anche il nickname attuale
          shared: document.getElementById('share-checkbox').checked,
          score: 0, // Inizializza lo score se è un nuovo reminder
          createdAt: serverTimestamp() // Per ordinamento
        };

        try {
          if (editingReminderId) { // Se stiamo modificando
            const reminderRef = doc(db, 'reminders', editingReminderId);
            await updateDoc(reminderRef, reminderData);
            alert("Reminder modificato con successo!");
          } else { // Se stiamo aggiungendo
            reminderData.score = 0; // Assicurati che i nuovi reminder abbiano uno score
            await addDoc(collection(db, 'reminders'), reminderData);
            alert("Reminder aggiunto con successo!");
          }
          newReminderModal.hide();
          clearReminderModal();
        } catch (err) {
          console.error("Errore salvataggio reminder:", err);
          alert("Errore durante il salvataggio del reminder: " + err.message);
        }
      });

      // Abilita/disabilita input durata timer
      document.getElementById('timer-enabled').addEventListener('change', function () {
        document.getElementById('timer-duration').disabled = !this.checked;
        if (!this.checked) {
            document.getElementById('timer-duration').value = '';
        }
      });

      // Notifiche browser
      if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
        Notification.requestPermission();
      }


      // Listener autenticazione
      onAuthStateChanged(auth, (user) => {
        document.getElementById('auth-container').style.display = user ? 'none' : 'block';
        document.getElementById('app-container').style.display = user ? 'block' : 'none';
        if (user) {
          currentUser = user;
          checkAndPromptForNickname(user); // Controlla/chiedi nickname qui
          loadMyReminders(user.uid);
          loadSharedReminders(); // Carica anche i condivisi
        } else {
          currentUser = null;
          userNickname = '';
          document.getElementById('reminders-list').innerHTML = ''; // Pulisci la lista dei tuoi reminder
          document.getElementById('shared-reminders-list').innerHTML = ''; // Pulisci la lista dei reminder condivisi
          document.getElementById('user-nickname-display').style.display = 'none';
        }
      });
    }); // Fine DOMContentLoaded

    function loadMyReminders(userId) {
      const q = query(collection(db, 'reminders'), where('userId', '==', userId), orderBy('createdAt', 'desc'));
      onSnapshot(q, (snapshot) => {
        const reminders = [];
        snapshot.forEach(doc => reminders.push({ id: doc.id, ...doc.data() }));
        renderMyReminders(reminders);
        scheduleNotifications(reminders.filter(r => r.userId === currentUser?.uid)); // Solo notifiche per i propri reminder
      }, (error) => {
          console.error("Errore caricamento Miei Reminder: ", error);
      });
    }

    function renderMyReminders(reminders) {
      const container = document.getElementById('reminders-list');
      if (!container) return;
      container.innerHTML = reminders.map(reminder => `
        <div class="col-md-6 col-lg-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">${reminder.title}</h5>
              ${reminder.description ? `<p class="card-text text-muted">${reminder.description}</p>` : ''}
              ${reminder.time ? `<p class="card-text"><small>Ora: ${reminder.time}</small></p>` : ''}
              ${reminder.days && reminder.days.length > 0 ? `<p class="card-text"><small>Giorni: ${reminder.days.map(d => ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"][d]).join(', ')}</small></p>` : ''}
              ${reminder.timerEnabled && reminder.timerDuration > 0 ? `
                <div class="timer-dynamic-container" data-duration="${reminder.timerDuration}">
                  </div>
              ` : ''}
              <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary me-2" onclick="window.editMyReminder('${reminder.id}')">Modifica</button>
                <button class="btn btn-sm btn-danger" onclick="window.deleteReminder('${reminder.id}')">Elimina</button>
              </div>
            </div>
          </div>
        </div>
      `).join('');

      reminders.forEach((reminder) => {
        if(reminder.timerEnabled && reminder.timerDuration > 0) {
          // Trova il container specifico per questo reminder
          const allTimerContainers = container.querySelectorAll(`.timer-dynamic-container[data-duration="${reminder.timerDuration}"]`);
          // Questo approccio è un po' grezzo se ci sono più timer con la stessa durata.
          // Sarebbe meglio dare ID univoci o passare l'elemento direttamente.
          // Per ora, si assume che l'ordine sia mantenuto o che non ci siano troppe collisioni.
          const timerCardElement = Array.from(allTimerContainers).find(el => !el.classList.contains('timer-initialized'));
          if (timerCardElement) {
            const template = document.getElementById('timer-template').content.cloneNode(true);
            timerCardElement.appendChild(template);
            setupTimer(reminder.timerDuration, timerCardElement);
            timerCardElement.classList.add('timer-initialized'); // Marca come inizializzato
          }
        }
      });
    }

    window.editMyReminder = async function (id) {
        const reminderRef = doc(db, 'reminders', id);
        const reminderSnap = await getDoc(reminderRef);
        if (reminderSnap.exists()) {
            const reminder = reminderSnap.data();
            editingReminderId = id; // Imposta l'ID per la modifica

            document.getElementById('reminder-id').value = id;
            document.getElementById('reminder-title').value = reminder.title;
            document.getElementById('reminder-description').value = reminder.description || '';
            document.getElementById('reminder-time').value = reminder.time || '';

            document.getElementById('reminder-days').querySelectorAll('option').forEach(opt => {
                opt.selected = reminder.days && reminder.days.includes(opt.value);
            });

            document.getElementById('timer-enabled').checked = reminder.timerEnabled || false;
            const timerDurationInput = document.getElementById('timer-duration');
            timerDurationInput.value = reminder.timerDuration || '';
            timerDurationInput.disabled = !reminder.timerEnabled;

            document.getElementById('share-checkbox').checked = reminder.shared || false;
            document.getElementById('reminderModalTitle').textContent = 'Modifica Reminder';
            newReminderModal.show();
        } else {
            alert("Reminder non trovato!");
        }
    };

    window.deleteReminder = async function (id) {
      if (confirm("Sei sicuro di voler eliminare questo reminder?")) {
        try {
          await deleteDoc(doc(db, 'reminders', id));
          alert("Reminder eliminato.");
        } catch (err) {
          alert("Errore eliminazione: " + err.message);
        }
      }
    };

    function scheduleNotifications(reminders) {
      // Implementazione base, potrebbe necessitare di logica più avanzata per notifiche persistenti
      reminders.forEach(reminder => {
        if (!reminder.time || !reminder.days || reminder.days.length === 0) return;

        reminder.days.forEach(day => {
          const nextDate = getNextOccurrence(day, reminder.time);
          const timeout = nextDate.getTime() - Date.now();

          if (timeout > 0 && timeout < 2147483647) { // Max timeout per setTimeout
            setTimeout(() => {
              showNotification(`Reminder: ${reminder.title}${reminder.description ? ' - ' + reminder.description : ''}`);
              if (reminder.timerEnabled && reminder.timerDuration > 0) {
                // Non avviare il timer della notifica qui, ma gestiscilo con l'UI del timer
              }
            }, timeout);
          }
        });
      });
    }

    function getNextOccurrence(dayNumber, timeString) {
      const [hours, minutes] = timeString.split(':');
      const now = new Date();
      let date = new Date(); // Crea una nuova istanza per evitare modifiche a 'now'
      date.setHours(parseInt(hours), parseInt(minutes), 0, 0);

      // Se l'ora odierna è già passata O se oggi non è il giorno giusto, passa al giorno successivo.
      if (date < now || date.getDay() !== parseInt(dayNumber)) {
          if (date.getDay() === parseInt(dayNumber) && date < now) { // Oggi è il giorno giusto ma l'ora è passata
             date.setDate(date.getDate() + 7); // Vai alla prossima settimana
          } else { // Cerca il prossimo giorno corretto
            date.setDate(date.getDate() + (parseInt(dayNumber) - date.getDay() + 7) % 7);
             // Se il calcolo porta a una data passata (es. oggi è Martedì, cerco Lunedì), aggiungi 7 giorni
            if (date < now && date.getDay() === parseInt(dayNumber)) {
                date.setDate(date.getDate() + 7);
            } else if (date < now && date.getDay() !== parseInt(dayNumber)){
                 // Caso in cui il giorno calcolato è oggi ma l'ora è passata
                 // e il giorno della settimana non è ancora quello giusto
                 // esempio: oggi è mercoledì ore 15, cerco un reminder per martedì alle 10
                 // il calcolo (2 - 3 + 7)%7 = 6 (sabato), non corretto
                 // Bisogna trovare il prossimo giorno corretto
                 let daysToAdd = (parseInt(dayNumber) - now.getDay() + 7) % 7;
                 if (daysToAdd === 0 && (date.getHours() < now.getHours() || (date.getHours() === now.getHours() && date.getMinutes() <= now.getMinutes()))) {
                    daysToAdd = 7; // se è lo stesso giorno ma l'ora è passata
                 }
                 date = new Date(); // riparti da now
                 date.setDate(now.getDate() + daysToAdd);
                 date.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            }
          }
      }
      return date;
    }

    function showNotification(message) {
      if (Notification.permission === 'granted') {
        new Notification('Workout Inside', { body: message });
      }
    }

    function setupTimer(durationMinutes, timerElementContainer) {
        if (!timerElementContainer || durationMinutes <= 0) return;

        let timerSeconds = durationMinutes * 60;
        const progressBar = timerElementContainer.querySelector('.progress-bar-timer');
        const startBtn = timerElementContainer.querySelector('.btn-start-timer');

        if (!progressBar || !startBtn) {
            console.warn("Elementi del timer non trovati nel container fornito:", timerElementContainer);
            return;
        }
        
        // Resetta stato bottone e progress bar se già esistente
        progressBar.style.width = '100%';
        startBtn.disabled = false;
        startBtn.textContent = 'Avvia Timer';
        if(startBtn.intervalId) clearInterval(startBtn.intervalId);


        startBtn.addEventListener('click', () => {
            if (startBtn.disabled) return; // Evita click multipli se già avviato
            startBtn.disabled = true;
            startBtn.textContent = 'In Corso...';
            
            const totalDuration = durationMinutes * 60; // Salva la durata iniziale
            timerSeconds = totalDuration; // Resetta i secondi rimanenti

            progressBar.style.width = '100%'; // Assicura che parta da 100%

            const interval = setInterval(() => {
                timerSeconds--;
                const widthPercent = Math.max(0, (timerSeconds / totalDuration) * 100);
                progressBar.style.width = `${widthPercent}%`;

                if (timerSeconds <= 0) {
                    clearInterval(interval);
                    startBtn.textContent = 'Timer Scaduto';
                    startBtn.classList.remove('btn-success');
                    startBtn.classList.add('btn-secondary');
                    // Opzionale: rimuovere il timer o mostrare un messaggio
                    showNotification(`Timer di ${durationMinutes} minuti scaduto!`);
                }
            }, 1000);
            startBtn.intervalId = interval; // Salva l'ID per poterlo cancellare
        });
    }


    let sharedRemindersUnsubscribe = null; // Per gestire il listener di Firestore

    async function loadSharedReminders() {
        if (sharedRemindersUnsubscribe) {
            sharedRemindersUnsubscribe(); // Cancella il listener precedente se esiste
        }

        const searchInput = document.getElementById('search-shared-reminders');
        const sortSelect = document.getElementById('sort-shared-reminders');

        let baseQuery = query(collection(db, 'reminders'), where('shared', '==', true));
        
        // Applica l'ordinamento iniziale
        const sortType = sortSelect.value;
        if (sortType === 'Ordina per punteggio') {
            baseQuery = query(baseQuery, orderBy('score', 'desc'));
        } else if (sortType === 'Ordina per data (nuovi prima)') {
            baseQuery = query(baseQuery, orderBy('createdAt', 'desc'));
        }
        // Per 'Ordina casualmente' l'ordinamento avviene client-side dopo il fetch

        sharedRemindersUnsubscribe = onSnapshot(baseQuery, async (snapshot) => {
            let fetchedReminders = [];
            for (const docSnap of snapshot.docs) {
                const data = docSnap.data();
                const nickname = data.userNickname || await fetchUserNickname(data.userId); // Usa il nickname salvato o recuperalo
                fetchedReminders.push({
                    id: docSnap.id,
                    ...data,
                    userNickname: nickname // Assicurati che il nickname sia qui
                });
            }
            applySharedFiltersAndSort(fetchedReminders, searchInput.value, sortSelect.value);
        }, (error) => {
            console.error("Errore caricamento Reminder Condivisi: ", error);
        });

        searchInput.addEventListener('input', (e) => {
            // Per la ricerca client-side, dobbiamo avere tutti i dati e poi filtrare
            // Questo richiede di ricaricare i dati senza il filtro di testo da Firestore
            // e poi applicare il filtro di testo e l'ordinamento localmente.
            // O, più semplicemente, rifare la query con l'ordinamento e filtrare client-side
            // Per ora, filtriamo i risultati già caricati.
            // Potrebbe essere necessario un re-fetch se il dataset è molto grande e si vuole una ricerca server-side.
             if (sharedRemindersUnsubscribe) sharedRemindersUnsubscribe(); // Stoppa il vecchio listener
             loadSharedReminders(); // Ricarica con i nuovi criteri (se l'ordinamento cambia)
                                    // o semplicemente riapplica i filtri sui dati attuali se l'ordinamento non cambia
        });

        sortSelect.addEventListener('change', (e) => {
            if (sharedRemindersUnsubscribe) sharedRemindersUnsubscribe();
            loadSharedReminders(); // Ricarica con il nuovo ordinamento
        });
    }

    function applySharedFiltersAndSort(reminders, searchTerm, sortType) {
        let filtered = [...reminders]; // Crea una copia per non modificare l'array originale

        // Filtro per termine di ricerca (client-side)
        if (searchTerm) {
            const lowerSearchTerm = searchTerm.toLowerCase();
            filtered = filtered.filter(reminder =>
                (reminder.title && reminder.title.toLowerCase().includes(lowerSearchTerm)) ||
                (reminder.description && reminder.description.toLowerCase().includes(lowerSearchTerm))
            );
        }

        // Ordinamento (client-side per "casuale", altrimenti Firestore dovrebbe averlo già fatto)
        if (sortType === 'Ordina casualmente') {
            filtered.sort(() => Math.random() - 0.5);
        }
        // Altri ordinamenti sono gestiti da Firestore nella query `baseQuery`
        renderSharedReminders(filtered);
    }


    function renderSharedReminders(filteredReminders) {
        const container = document.getElementById('shared-reminders-list');
        if (!container) return;

        container.innerHTML = filteredReminders.map(reminder => `
        <div class="col-md-6 col-lg-4">
          <div class="card reminder-card shadow-sm mb-3" data-reminder-id="${reminder.id}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h5 class="card-title">${reminder.title}</h5>
                  ${reminder.description ? `<p class="card-text text-muted">${reminder.description}</p>` : '<p class="card-text text-muted"><em>Nessuna descrizione</em></p>'}
                  <p class="card-text"><small>Condiviso da: ${reminder.userNickname || 'Utente Anonimo'}</small></p>
                </div>
                <div class="d-flex flex-column align-items-center gap-1">
                  <button class="btn btn-sm btn-outline-success vote-btn" 
                          onclick="event.stopPropagation(); window.voteReminder('${reminder.id}', 'up')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-up-short" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 12a.5.5 0 0 0 .5-.5V5.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 5.707V11.5a.5.5 0 0 0 .5.5z"/></svg>
                  </button>
                  <span class="badge bg-primary rounded-pill">${reminder.score || 0}</span>
                  <button class="btn btn-sm btn-outline-danger vote-btn" 
                          onclick="event.stopPropagation(); window.voteReminder('${reminder.id}', 'down')">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down-short" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v5.793l2.146-2.147a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 0 1 .708-.708L7.5 10.293V4.5A.5.5 0 0 1 8 4z"/></svg>
                  </button>
                </div>
              </div>
              ${reminder.time ? `<p class="card-text mt-2"><small>Ora: ${reminder.time}</small></p>` : ''}
              ${reminder.days && reminder.days.length > 0 ? `<p class="card-text"><small>Giorni: ${reminder.days.map(d => ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"][d]).join(', ')}</small></p>` : ''}
              ${reminder.timerEnabled && reminder.timerDuration > 0 ? `
                <div class="timer-dynamic-container mt-2" data-duration="${reminder.timerDuration}">
                  </div>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');

        // Aggiungi event listener per aprire il modal quando si clicca un reminder condiviso
        container.querySelectorAll('.reminder-card').forEach(card => {
            card.addEventListener('click', async function() {
                const reminderId = this.dataset.reminderId;
                const reminderRef = doc(db, 'reminders', reminderId);
                const reminderSnap = await getDoc(reminderRef);

                if (reminderSnap.exists()) {
                    const sharedData = reminderSnap.data();
                    clearReminderModal(); // Pulisci il modal

                    document.getElementById('reminder-title').value = sharedData.title;
                    document.getElementById('reminder-description').value = sharedData.description || '';
                    document.getElementById('reminder-time').value = sharedData.time || '';
                    document.getElementById('reminder-days').querySelectorAll('option').forEach(opt => {
                        opt.selected = sharedData.days && sharedData.days.includes(opt.value);
                    });
                    document.getElementById('timer-enabled').checked = sharedData.timerEnabled || false;
                    const timerDurationInput = document.getElementById('timer-duration');
                    timerDurationInput.value = sharedData.timerDuration || '';
                    timerDurationInput.disabled = !sharedData.timerEnabled;
                    
                    // Non pre-compilare "shared" o ID esistente, è un NUOVO reminder per l'utente
                    document.getElementById('share-checkbox').checked = false; // L'utente decide se ricondividere
                    document.getElementById('reminderModalTitle').textContent = 'Crea Reminder da Condiviso';
                    editingReminderId = null; // Assicura che sia un nuovo reminder
                    newReminderModal.show();
                }
            });

            // Inizializza i timer per i reminder condivisi
            const reminderData = filteredReminders.find(r => r.id === card.dataset.reminderId);
             if (reminderData && reminderData.timerEnabled && reminderData.timerDuration > 0) {
                const timerContainerElement = card.querySelector(`.timer-dynamic-container[data-duration="${reminderData.timerDuration}"]`);
                if (timerContainerElement && !timerContainerElement.classList.contains('timer-initialized')) {
                    const template = document.getElementById('timer-template').content.cloneNode(true);
                    timerContainerElement.appendChild(template);
                    setupTimer(reminderData.timerDuration, timerContainerElement);
                    timerContainerElement.classList.add('timer-initialized');
                }
            }
        });
    }


    window.voteReminder = async function(id, voteType) {
        if (!currentUser) {
            alert("Devi essere loggato per votare.");
            return;
        }
        try {
            const reminderRef = doc(db, 'reminders', id);
            await updateDoc(reminderRef, {
            score: increment(voteType === 'up' ? 1 : -1)
            });
            // Non c'è bisogno di alert, l'UI si aggiornerà con onSnapshot
        } catch (err) {
            console.error("Errore nel voto:", err);
            alert('Si è verificato un errore durante il voto: ' + err.message);
        }
    };

    // Gestione navigazione
    document.querySelectorAll('#main-nav .nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        // Non prevenire il default se è un link per un modal
        if (!e.target.dataset.bsToggle) {
            e.preventDefault();
            document.querySelectorAll('#main-nav .nav-link').forEach(nl => nl.classList.remove('active'));
            e.target.classList.add('active');

            document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
            });
            const targetSectionId = e.target.dataset.bsTarget;
            if (targetSectionId) {
                document.getElementById(targetSectionId).style.display = 'block';
            }
        }
      });
    });

    // Imposta la sezione iniziale (Miei Reminder) come attiva
    document.addEventListener('DOMContentLoaded', () => {
        const initialTarget = document.querySelector('#main-nav .nav-link.active');
        if (initialTarget && initialTarget.dataset.bsTarget) {
            document.getElementById(initialTarget.dataset.bsTarget).style.display = 'block';
        }
    });

  </script>
</body>
</html>
