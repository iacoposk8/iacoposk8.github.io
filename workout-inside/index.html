<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Workout Inside - Reminder</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .progress-bar-timer { transition: width 1s linear; }
    .reminder-card { transition: transform 0.2s; cursor: pointer; }
    .reminder-card:hover { transform: translateY(-2px); }
    [data-bs-target="shared-reminders"] .badge { font-size: 0.8em; }
  </style>
</head>
<body class="bg-light">
  <!-- Navbar e Modals -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">Workout Inside</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto" id="main-nav">
          <li class="nav-item"><a class="nav-link active" href="#" data-bs-target="my-reminders">Miei Reminder</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-bs-target="shared-reminders">Reminder</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-bs-target="questions">Domande</a></li>
        </ul>
        <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#profileModal">Profilo</button>
        <button id="btn-logout" class="btn btn-outline-light">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- Auth Container -->
    <div id="auth-container" class="row justify-content-center">
      <!-- Form autenticazione esistente -->
    </div>

    <!-- App Container -->
    <div id="app-container" style="display: none;">
      <!-- Sezioni contenuto esistenti -->
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="newReminderModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><span id="modal-mode">Nuovo</span> Reminder</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editing-id">
          <input type="text" id="reminder-title" class="form-control mb-2" placeholder="Titolo">
          <textarea id="reminder-description" class="form-control mb-2" placeholder="Descrizione"></textarea>
          <!-- Altri campi esistenti -->
          <button id="btn-save-reminder" class="btn btn-primary w-100">Salva</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="profileModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Modifica Profilo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="user-nickname" class="form-control mb-3" placeholder="Nickname">
          <button id="btn-save-profile" class="btn btn-primary w-100">Salva</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { 
      initializeApp, 
      deleteApp 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, deleteDoc, doc, 
      onSnapshot, query, where, updateDoc, increment, getDoc, setDoc 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAAHS48qlq5rC-E9F1RbcIRwN_x71oceTo",
      authDomain: "workout-inside-23d9b.firebaseapp.com",
      projectId: "workout-inside-23d9b",
      storageBucket: "workout-inside-23d9b.appspot.com",
      messagingSenderId: "54802022321",
      appId: "1:54802022321:web:f88980bdef5dc255d54790"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUserData = null;

    // Gestione profilo utente
    async function updateProfile(nickname) {
      const user = auth.currentUser;
      if (!user) return;
      
      await setDoc(doc(db, 'users', user.uid), {
        uid: user.uid,
        nickname: nickname,
        email: user.email,
        lastUpdate: new Date()
      });
      currentUserData = { ...currentUserData, nickname };
    }

    async function loadUserProfile(uid) {
      const docRef = doc(db, 'users', uid);
      const docSnap = await getDoc(docRef);
      currentUserData = docSnap.exists() ? docSnap.data() : null;
      
      if (!currentUserData?.nickname) {
        new bootstrap.Modal('#profileModal').show();
      }
    }

    // Gestione reminder
    async function saveReminder(data, isEdit = false) {
      try {
        if (data.shared && !currentUserData?.nickname) {
          alert('Devi impostare un nickname per condividere i reminder!');
          new bootstrap.Modal('#profileModal').show();
          return;
        }

        const reminderData = {
          ...data,
          sharedBy: data.shared ? currentUserData.nickname : null,
          userId: auth.currentUser.uid,
          timestamp: new Date()
        };

        if (isEdit) {
          await updateDoc(doc(db, 'reminders', data.id), reminderData);
        } else {
          await addDoc(collection(db, 'reminders'), reminderData);
        }
      } catch (err) {
        alert(`Errore durante il salvataggio: ${err.message}`);
      }
    }

    function setupReminderClick(card, reminder) {
      card.addEventListener('click', () => {
        if (reminder.userId === auth.currentUser?.uid) return;
        
        document.getElementById('reminder-title').value = reminder.title;
        document.getElementById('reminder-description').value = reminder.description;
        // Popola altri campi
        new bootstrap.Modal('#newReminderModal').show();
      });
    }

    // Renderizzazione reminder
    function renderReminder(reminder, isOwner = false) {
      const card = document.createElement('div');
      card.className = 'col-md-6 mb-3';
      card.innerHTML = `
        <div class="card reminder-card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">${reminder.title}</h5>
            <p class="card-text text-muted">${reminder.description}</p>
            ${reminder.sharedBy ? `
              <small class="text-muted">Condiviso da: ${reminder.sharedBy}</small>
            ` : ''}
            ${isOwner ? `
              <div class="mt-2">
                <button class="btn btn-sm btn-warning me-2 edit-btn">Modifica</button>
                <button class="btn btn-sm btn-danger delete-btn">Elimina</button>
              </div>
            ` : ''}
          </div>
        </div>
      `;

      if (isOwner) {
        card.querySelector('.delete-btn').onclick = () => deleteReminder(reminder.id);
        card.querySelector('.edit-btn').onclick = () => {
          document.getElementById('editing-id').value = reminder.id;
          document.getElementById('reminder-title').value = reminder.title;
          document.getElementById('reminder-description').value = reminder.description;
          // Popola altri campi
          document.getElementById('modal-mode').textContent = 'Modifica';
          new bootstrap.Modal('#newReminderModal').show();
        };
      } else {
        setupReminderClick(card, reminder);
      }

      return card;
    }

    // Inizializzazione
    window.addEventListener('DOMContentLoaded', () => {
      // ... inizializzazione esistente ...

      // Gestione salvataggio reminder
      document.getElementById('btn-save-reminder').onclick = async () => {
        const reminderData = {
          title: document.getElementById('reminder-title').value,
          description: document.getElementById('reminder-description').value,
          // Recupera altri valori
        };

        const isEdit = !!document.getElementById('editing-id').value;
        await saveReminder(isEdit ? { id: document.getElementById('editing-id').value, ...reminderData } : reminderData, isEdit);
        
        $('#newReminderModal').modal('hide');
        document.getElementById('editing-id').value = '';
      };

      // Gestione profilo
      document.getElementById('btn-save-profile').onclick = async () => {
        await updateProfile(document.getElementById('user-nickname').value);
        $('#profileModal').modal('hide');
      };

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          await loadUserProfile(user.uid);
          loadReminders(user.uid);
        }
      });
    });
  </script>
</body>
</html>
