<!DOCTYPE html>
<html>
<head>
  <title>Push Notifications</title>
</head>
<body>
  <h2>Notifiche Push</h2>
  <button id="enable">Abilita notifiche</button>

  <script>
    const publicKey = 'MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAECrpUgxP/t2XNN94br/kGRkCoARcjL82rAod7W0Cp39/p7MQFC74Qqazm8mbQyLMTiG/ZsmKqA2oqz9ysP2Rb2w==';

    async function subscribeUser() {
      if (!('serviceWorker' in navigator)) return;
      const reg = await navigator.serviceWorker.register('sw.js');
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') return;

      const subscription = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey)
      });

      await fetch('https://server-git-main-iacoposk8s-projects.vercel.app/save-subscription', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(subscription)
      });

      alert('Notifiche abilitate!');
    }

    document.getElementById('enable').onclick = subscribeUser;

    function urlBase64ToUint8Array(base64) {
      const padding = '='.repeat((4 - base64.length % 4) % 4);
      const base64Clean = (base64 + padding).replace(/-/g, '+').replace(/_/g, '/');
      const raw = atob(base64Clean);
      return new Uint8Array([...raw].map(c => c.charCodeAt(0)));
    }
  </script>
</body>
</html>
